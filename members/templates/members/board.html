{% extends "members/base.html" %}
{% block title %}빙고판{% endblock %}
{% block extra_head %}
<style>
    .board-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap; margin-bottom: 14px; }
    .board-grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 12px; }
    .tile { position: relative; background: rgba(255,255,255,0.9); border: 1px solid #dfe8fa; border-radius: 16px; padding: 14px; box-shadow: 0 10px 26px rgba(20,40,100,0.08); min-height: 120px; display: flex; flex-direction: column; gap: 6px; cursor: pointer; transition: transform .12s ease, box-shadow .12s ease; }
    .tile:hover { transform: translateY(-2px); box-shadow: 0 14px 30px rgba(20,40,100,0.12); }
    .tile strong { color: #183973; }
    .empty { text-align: center; color: #667799; padding: 40px 0; }
    .status-pill { align-self: flex-start; padding: 6px 10px; border-radius: 12px; font-size: 12px; font-weight: 700; color: #fff; }
    .status-approved { background: linear-gradient(120deg, #1aa65a, #29c77b); }
    .status-pending { background: linear-gradient(120deg, #f7a000, #f77f00); }
    .status-rejected { background: linear-gradient(120deg, #ef4444, #b91c1c); }
    .tile.pending { border-color: #ffd599; background: #fff7ea; }
    .tile.approved { border-color: #b8e5cb; background: #f0fff6; }
    .tile.rejected { border-color: #f5b2b2; background: #fff2f2; }
    .modal-backdrop { position: fixed; inset: 0; background: rgba(8,19,46,0.45); display: none; align-items: center; justify-content: center; z-index: 50; padding: 16px; }
    .modal { width: min(680px, 100%); background: #fff; border-radius: 18px; box-shadow: 0 20px 50px rgba(8,24,68,0.3); padding: 22px; position: relative; max-height: 90vh; overflow-y: auto; }
    .modal h3 { margin: 0 0 6px; }
    .modal .subtitle { margin: 0 0 12px; }
    .modal-close { position: absolute; top: 12px; right: 12px; border: none; background: none; font-size: 20px; cursor: pointer; color: #4c5a78; }
    .form-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    label { font-weight: 700; margin-bottom: 4px; display: block; }
    input[type="text"], textarea { width: 100%; border-radius: 12px; border: 1px solid #cdd6eb; padding: 12px 14px; font-size: 15px; background: #f7f9ff; }
    textarea { min-height: 120px; resize: vertical; }
    input[type="file"] { margin-top: 6px; }
    .participants { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 8px; }
    .participant { background: #f4f6ff; border: 1px solid #d7def7; border-radius: 12px; padding: 8px 10px; display: flex; align-items: center; gap: 8px; }
    .actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 8px; }
    .btn { border: none; border-radius: 12px; padding: 12px 14px; font-weight: 800; cursor: pointer; }
    .btn-secondary { background: #e8edfb; color: #1c2f58; }
    .btn-primary { background: linear-gradient(120deg, #163a8c, #3572ff); color: #fff; box-shadow: 0 10px 20px rgba(34,78,181,0.2); }
    .btn-danger { background: linear-gradient(120deg, #f05f57, #e53935); color: #fff; }
    .error-block { color: #c62828; font-size: 13px; }
    .confetti-piece { position: fixed; width: 10px; height: 16px; background: var(--confetti-color); top: -20px; animation: fall 2.6s linear forwards; z-index: 60; }
    .helper { color: #7a869f; font-size: 13px; margin-top: 4px; }
    .modal-section { display: none; }
    .modal-section.active { display: block; }
    .section-title { font-size: 14px; font-weight: 800; color: #1f2f55; margin: 14px 0 6px; }
    .attachment-grid { display: grid; grid-template-columns: repeat(5, minmax(0, 1fr)); gap: 8px; margin-top: 6px; }
    .attachment-card { border: 1px solid #dfe5f5; border-radius: 12px; overflow: hidden; background: #f7f9ff; position: relative; }
    .attachment-thumb { width: 100%; height: 90px; object-fit: cover; display: block; background: #e6ecfa; }
    .attachment-meta { padding: 8px; font-size: 12px; color: #4d5a75; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .pill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; font-size: 12px; font-weight: 800; color: #fff; }
    .pill.pending { background: linear-gradient(120deg, #f7a000, #f77f00); }
    .pill.rejected { background: linear-gradient(120deg, #ef4444, #b91c1c); }
    .participant-list { display: flex; flex-wrap: wrap; gap: 6px; margin: 6px 0 0; }
    .participant-chip { background: #eef2ff; color: #2a3f7c; padding: 6px 10px; border-radius: 12px; font-weight: 700; font-size: 13px; }
    .drop-zone { border: 2px dashed #b5c6f3; border-radius: 14px; padding: 14px; text-align: center; background: #f5f7ff; transition: border-color .12s ease, background .12s ease; cursor: pointer; }
    .drop-zone.dragover { border-color: #2f6bff; background: #e9f0ff; }
    .drop-actions { display: flex; justify-content: center; gap: 10px; margin-top: 8px; flex-wrap: wrap; }
    .btn-ghost { border: 1px dashed #2f6bff; background: #fff; color: #1b3a7a; }
    .remove-chip { position: absolute; top: 6px; right: 6px; background: rgba(0,0,0,0.6); color: #fff; border: none; border-radius: 50%; width: 22px; height: 22px; cursor: pointer; font-weight: 800; }
    @keyframes fall { to { transform: translateY(110vh) rotate(360deg); opacity: 0.2; } }
    .history-bar { margin-top: 24px; display: flex; justify-content: flex-end; }
    .history-btn { border: 1px solid var(--border); background: #fff; color: #1c2f58; padding: 10px 14px; border-radius: 12px; cursor: pointer; box-shadow: var(--shadow); font-weight: 700; }
    .history-modal { width: min(720px, 100%); background: #fff; border-radius: 18px; box-shadow: 0 20px 50px rgba(8,24,68,0.3); padding: 20px; position: relative; }
    .history-list { max-height: 60vh; overflow: auto; margin-top: 12px; display: grid; gap: 10px; }
    .history-card { border: 1px solid #e3e8f5; border-radius: 12px; padding: 12px; background: #f7f9ff; display: grid; gap: 6px; }
    .history-status { display: inline-flex; align-items: center; gap: 6px; font-weight: 800; font-size: 13px; }
    .history-status .dot { width: 8px; height: 8px; border-radius: 999px; display: inline-block; }
    .bingo-toast {
        position: fixed; inset: 0; display: flex; align-items: center; justify-content: center;
        pointer-events: none; z-index: 70;
    }
    .bingo-toast .card {
        background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.95), rgba(235,243,255,0.95));
        padding: 24px 32px; border-radius: 18px; box-shadow: 0 20px 80px rgba(18,34,68,0.25);
        text-align: center; transform: scale(0.9); opacity: 0; animation: toast-pop 0.5s ease forwards;
        border: 1px solid #e2e8ff;
    }
    .bingo-toast h2 { margin: 0 0 6px; color: #0f1a2d; font-size: 22px; }
    .bingo-toast p { margin: 0; color: #4d5a75; }
    .bingo-toast .glow {
        position: absolute; inset: 0; background: radial-gradient(circle, rgba(53,114,255,0.12), transparent 60%);
        filter: blur(20px); z-index: -1;
    }
    @keyframes toast-pop {
        from { transform: translateY(20px) scale(0.9); opacity: 0; }
        to { transform: translateY(0) scale(1); opacity: 1; }
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="board-header">
        <div>
            <h1 style="margin: 0;">{{ member.name }}님의 빙고판</h1>
            <p class="subtitle">{{ member.get_team_display }} · 학번 {{ member.student_id }}</p>
        </div>
        <a href="{% url 'logout' %}" class="button-link">로그아웃</a>
    </div>

    {% if form_errors %}
        <div class="error-block">제출 중 오류가 있습니다: {{ form_errors|striptags }}</div>
    {% endif %}

    {% if board_data %}
        <div class="board-grid">
            {% for item, submission in board_data %}
                {% with status=submission.status|default_if_none:"" %}
                <div class="tile {% if status == 'pending' %}pending{% elif status == 'approved' %}approved{% elif status == 'rejected' %}rejected{% endif %}"
                     data-item-id="{{ item.id }}"
                     data-submission-id="{{ submission.id|default_if_none:'' }}"
                     data-title="{{ item.title }}"
                     data-desc="{{ item.description|default_if_none:'' }}"
                     data-status="{{ status|default:'new' }}">
                    <div style="font-size: 13px; color: #7c89a8;">#{{ item.position }}</div>
                    <strong>{{ item.title }}</strong>
                    {% if item.description %}
                        <div style="color: #607099; font-size: 14px; line-height: 1.5;">{{ item.description }}</div>
                    {% endif %}
                    {% if status %}
                        <span class="status-pill status-{{ status }}">
                            {% if status == "pending" %}검토중{% elif status == "approved" %}승인{% else %}반려{% endif %}
                        </span>
                        {% if status == "rejected" and submission.rejected_reason %}
                            <div style="color: #b91c1c; font-size: 13px;">사유: {{ submission.rejected_reason }}</div>
                        {% endif %}
                    {% endif %}
                </div>
                {% endwith %}
            {% endfor %}
        </div>
    {% else %}
        <div class="empty">
            아직 등록된 빙고 아이템이 없습니다. 관리자 페이지에서 내용을 채워주세요.
        </div>
    {% endif %}
</div>

<div class="history-bar">
    <button type="button" class="history-btn" id="history-btn">조 빙고 제출 이력</button>
</div>

<div class="modal-backdrop" id="submission-backdrop">
    <div class="modal">
        <button class="modal-close" type="button" id="modal-close">×</button>
        <h3 id="modal-title">활동 인증</h3>
        <p class="subtitle" id="modal-desc"></p>
        <div id="pending-detail" class="modal-section">
            <span class="pill pending" id="detail-status-pill">검토중</span>
            <div id="detail-reason" class="helper" style="display:none; color:#b91c1c;"></div>
            <div class="section-title">내가 제출한 내용</div>
            <div id="detail-content" style="white-space: pre-wrap; line-height: 1.5; color: #1f2f55;"></div>
            <div class="section-title">첨부한 파일</div>
            <div id="detail-attachments" class="attachment-grid"></div>
            <div class="section-title">함께한 팀원</div>
            <div class="participant-list" id="detail-participants"></div>
            <div class="actions">
                <button type="button" class="btn btn-secondary" id="detail-edit-btn">수정하기</button>
                <button type="button" class="btn btn-danger" id="detail-cancel-btn">등록 취소</button>
            </div>
        </div>

        <form id="submission-form" class="modal-section" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-grid">
                <div>
                    <label for="title-input">활동 제목</label>
                    <input type="text" id="title-input" name="title" required>
                </div>
                <div>
                    <label for="content-input">활동 내용</label>
                    <textarea id="content-input" name="content" required></textarea>
                </div>
                <div>
                    <label for="attachments-input">사진/동영상 첨부 (최대 5개)</label>
                    <div class="drop-zone" id="drop-zone">
                        파일을 드래그 앤 드랍하거나, 아래 버튼을 눌러 추가하세요.
                        <div class="drop-actions">
                            <button type="button" class="btn btn-ghost" id="file-select-btn">파일 첨부</button>
                        </div>
                        <input type="file" id="attachments-input" name="attachments" accept="image/*,video/*" multiple style="display:none;">
                    </div>
                    <div class="helper">사진/영상만 업로드 가능하며 최대 5개까지 첨부할 수 있습니다.</div>
                    <div class="section-title" id="existing-attachments-title" style="display: none; margin-bottom: 4px;">현재 첨부된 파일</div>
                    <div id="existing-attachments" class="attachment-grid"></div>
                    <div class="section-title" style="margin-bottom: 4px;">선택한 파일 미리보기</div>
                    <div id="attachment-previews" class="attachment-grid"></div>
                </div>
                <div>
                    <label>참가 팀원 (본인 제외, 최소 3명 체크)</label>
                    <div class="participants">
                        {% for teammate in team_members %}
                            {% if teammate.id != member.id %}
                            <label class="participant">
                                <input type="checkbox" name="participants" value="{{ teammate.id }}">
                                <span>{{ teammate.name }}</span>
                            </label>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <div class="helper">본인을 포함해 4명 이상이어야 인정됩니다.</div>
                </div>
            </div>
            <div class="actions">
                <button type="button" class="btn btn-secondary" id="cancel-btn">닫기</button>
                <button type="submit" class="btn btn-primary" id="submit-btn-text">제출하기</button>
            </div>
        </form>
        <form id="cancel-form" method="post" style="display: none;">{% csrf_token %}</form>
    </div>
</div>

<div class="modal-backdrop" id="history-backdrop">
    <div class="history-modal">
        <button class="modal-close" type="button" id="history-close">×</button>
        <h3 style="margin:0;">조 빙고 제출 이력</h3>
        <p class="subtitle" style="margin-bottom:8px;">현재 팀에서 제출한 빙고 항목의 상태를 볼 수 있습니다.</p>
        <div class="history-list" id="history-list"></div>
    </div>
</div>

{{ submission_details|json_script:"submission-data" }}

<script>
    const submissionData = JSON.parse(document.getElementById('submission-data').textContent || "{}");
    const currentMemberId = {{ member.id }};
    const tiles = document.querySelectorAll('.tile');
    const backdrop = document.getElementById('submission-backdrop');
    const modalTitle = document.getElementById('modal-title');
    const modalDesc = document.getElementById('modal-desc');
    const form = document.getElementById('submission-form');
    const formSection = document.getElementById('submission-form');
    const detailSection = document.getElementById('pending-detail');
    const cancelBtn = document.getElementById('cancel-btn');
    const closeBtn = document.getElementById('modal-close');
    const detailContent = document.getElementById('detail-content');
    const detailAttachments = document.getElementById('detail-attachments');
    const detailParticipants = document.getElementById('detail-participants');
    const detailStatusPill = document.getElementById('detail-status-pill');
    const detailReason = document.getElementById('detail-reason');
    const detailEditBtn = document.getElementById('detail-edit-btn');
    const detailCancelBtn = document.getElementById('detail-cancel-btn');
    const cancelForm = document.getElementById('cancel-form');
    const attachmentInput = document.getElementById('attachments-input');
    const attachmentPreviews = document.getElementById('attachment-previews');
    const existingAttachments = document.getElementById('existing-attachments');
    const existingAttachmentsTitle = document.getElementById('existing-attachments-title');
    const submitBtn = document.getElementById('submit-btn-text');
    const dropZone = document.getElementById('drop-zone');
    const fileSelectBtn = document.getElementById('file-select-btn');
    const historyBtn = document.getElementById('history-btn');
    const historyBackdrop = document.getElementById('history-backdrop');
    const historyClose = document.getElementById('history-close');
    const historyList = document.getElementById('history-list');
    const bingoLineCompleted = {{ bingo_line_completed|yesno:"true,false" }};
    const confirmMessage = "인스타그램에 cogsciin 을 태그해서 인증샷 스토리로 올려주시고 문화부장에게 확인 요청 하시면 바로 승인해드리겠습니다!";

    let activeItemId = null;
    let activeSubmissionId = null;
    let currentDetail = null;
    let fileQueue = [];
    const supportsDataTransfer = typeof DataTransfer !== "undefined";

    function showSection(target) {
        [formSection, detailSection].forEach(section => section.classList.remove('active'));
        target.classList.add('active');
    }

    function setParticipants(ids) {
        const boxes = form.querySelectorAll('input[name="participants"]');
        boxes.forEach(box => { box.checked = ids.includes(parseInt(box.value, 10)); });
    }

    function renderAttachments(container, attachments) {
        container.innerHTML = '';
        if (!attachments || !attachments.length) {
            container.innerHTML = '<div class="helper">첨부된 파일이 없습니다.</div>';
            return;
        }
        attachments.forEach(att => {
            const card = document.createElement('div');
            card.className = 'attachment-card';
            if (att.kind === 'image') {
                const img = document.createElement('img');
                img.src = att.url;
                img.alt = att.name;
                img.className = 'attachment-thumb';
                card.appendChild(img);
            } else if (att.kind === 'video') {
                const video = document.createElement('video');
                video.src = att.url;
                video.controls = true;
                video.muted = true;
                video.className = 'attachment-thumb';
                card.appendChild(video);
            }
            const meta = document.createElement('div');
            meta.className = 'attachment-meta';
            meta.textContent = att.name;
            card.appendChild(meta);
            container.appendChild(card);
        });
    }

    function renderSelectedPreviews(files) {
        attachmentPreviews.innerHTML = '';
        if (!files.length) {
            attachmentPreviews.innerHTML = '<div class="helper">선택된 파일이 없습니다.</div>';
            return;
        }
        files.forEach((file, idx) => {
            if (!(file.type.startsWith('image/') || file.type.startsWith('video/'))) return;
            const card = document.createElement('div');
            card.className = 'attachment-card';
            const remove = document.createElement('button');
            remove.type = 'button';
            remove.className = 'remove-chip';
            remove.textContent = '×';
            remove.addEventListener('click', () => {
                fileQueue = fileQueue.filter((_, i) => i !== idx);
                syncInputFiles();
                renderSelectedPreviews(fileQueue);
            });
            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.className = 'attachment-thumb';
                img.onload = () => URL.revokeObjectURL(img.src);
                card.appendChild(img);
            } else {
                const video = document.createElement('video');
                video.src = URL.createObjectURL(file);
                video.className = 'attachment-thumb';
                video.muted = true;
                video.controls = true;
                video.onloadeddata = () => URL.revokeObjectURL(video.src);
                card.appendChild(video);
            }
            const meta = document.createElement('div');
            meta.className = 'attachment-meta';
            meta.textContent = file.name;
            card.appendChild(meta);
            card.appendChild(remove);
            attachmentPreviews.appendChild(card);
        });
    }

    function syncInputFiles() {
        if (!supportsDataTransfer) {
            // 일부 브라우저는 input.files 할당을 막으므로 그대로 둔다.
            return;
        }
        const dt = new DataTransfer();
        fileQueue.forEach(f => dt.items.add(f));
        attachmentInput.files = dt.files;
    }

    function addFiles(files) {
        const newFiles = [];
        const existingCount = parseInt(form.dataset.existingCount || '0', 10);
        let skippedType = false;
        let skippedCount = false;
        files.forEach(f => {
            if (!(f.type.startsWith('image/') || f.type.startsWith('video/'))) { skippedType = true; return; }
            const total = existingCount + fileQueue.length + newFiles.length + 1;
            if (total > 5) { skippedCount = true; return; }
            newFiles.push(f);
        });
        if (skippedType) { alert("사진 또는 동영상 파일만 첨부할 수 있습니다."); }
        if (skippedCount) { alert("첨부 파일은 최대 5개까지만 가능합니다."); }
        if (newFiles.length === 0) { return; }
        fileQueue = fileQueue.concat(newFiles);
        syncInputFiles();
        renderSelectedPreviews(fileQueue);
    }

    function setDetailStatus(status, reason) {
        const label = status === 'approved' ? '승인' : status === 'rejected' ? '반려' : '검토중';
        detailStatusPill.textContent = label;
        detailStatusPill.className = `pill ${status}`;
        if (status === 'rejected' && reason) {
            detailReason.style.display = 'block';
            detailReason.textContent = `반려 사유: ${reason}`;
        } else {
            detailReason.style.display = 'none';
            detailReason.textContent = '';
        }
    }

    function historyStatusLabel(status) {
        if (status === 'approved') return { label: '승인', color: '#1aa65a' };
        if (status === 'rejected') return { label: '반려', color: '#ef4444' };
        return { label: '검토중', color: '#f59e0b' };
    }

    function renderHistory() {
        const entries = Object.values(submissionData || {}).sort(
            (a, b) => (a.item_position || 0) - (b.item_position || 0)
        );
        historyList.innerHTML = '';
        if (!entries.length) {
            historyList.innerHTML = '<div class="helper">아직 제출한 빙고가 없습니다.</div>';
            return;
        }
        entries.forEach((item) => {
            const wrap = document.createElement('div');
            wrap.className = 'history-card';
            const statusMeta = historyStatusLabel(item.status);
            wrap.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <strong>#${item.item_position} ${item.item_title}</strong>
                    <span class="history-status" style="color:${statusMeta.color};">
                        <span class="dot" style="background:${statusMeta.color};"></span>${statusMeta.label}
                    </span>
                </div>
                <div style="color:#4d5a75;">${item.content || ''}</div>
                ${item.status === 'rejected' ? `<div style="color:#b91c1c; font-size:13px;">반려 사유: ${item.rejected_reason || '사유 없음'}</div>` : ''}
            `;
            historyList.appendChild(wrap);
        });
    }

    function launchConfetti() {
        const colors = ["#ff5f6d", "#ffc371", "#2af598", "#22d3ee", "#a78bfa"];
        for (let i = 0; i < 120; i++) {
            const el = document.createElement('div');
            el.className = 'confetti-piece';
            el.style.left = Math.random() * 100 + 'vw';
            el.style.setProperty('--confetti-color', colors[i % colors.length]);
            el.style.animationDelay = (Math.random() * 0.8) + 's';
            el.style.transform = `rotate(${Math.random() * 360}deg)`;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 3200);
        }
    }

    function showBingoToast() {
        const toast = document.createElement('div');
        toast.className = 'bingo-toast';
        toast.innerHTML = `
            <div class="card">
                <div class="glow"></div>
                <h2>축하합니다! 빙고를 완성하셨습니다!</h2>
                <p>한 줄을 채웠어요. 팀원들과 함께 자축하세요!</p>
            </div>
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2400);
    }

    function closeModal() {
        backdrop.style.display = 'none';
        form.reset();
        fileQueue = [];
        syncInputFiles();
        renderSelectedPreviews([]);
        existingAttachments.innerHTML = '';
        existingAttachmentsTitle.style.display = 'none';
        currentDetail = null;
        activeItemId = null;
        activeSubmissionId = null;
    }

    function openForm(itemId, title, desc, mode = 'create', data = null) {
        form.reset();
        setParticipants([]);
        activeItemId = itemId;
        activeSubmissionId = data && data.id ? data.id : null;
        modalTitle.textContent = title;
        modalDesc.textContent = desc || "활동 내용을 작성하고 팀원들을 체크해주세요.";
        form.dataset.mode = mode;
        form.dataset.existingCount = mode === 'edit' && data ? (data.attachments || []).length : 0;
        fileQueue = [];
        syncInputFiles();
        renderSelectedPreviews([]);
        existingAttachments.innerHTML = '';
        if (mode === 'create') {
            form.action = `{% url 'submit_bingo_item' 0 %}`.replace('/0/', `/${itemId}/`);
            submitBtn.textContent = "제출하기";
            existingAttachmentsTitle.style.display = 'none';
        } else if (data) {
            form.action = `{% url 'update_submission' 0 %}`.replace('/0/', `/${data.id}/`);
            document.getElementById('title-input').value = data.title;
            document.getElementById('content-input').value = data.content;
            setParticipants(data.participant_ids || []);
            renderAttachments(existingAttachments, data.attachments || []);
            existingAttachmentsTitle.style.display = (data.attachments || []).length ? 'block' : 'none';
            submitBtn.textContent = "수정 완료";
        }
        showSection(formSection);
        backdrop.style.display = 'flex';
    }

    function openDetail(itemId, data) {
        activeItemId = itemId;
        activeSubmissionId = data.id;
        currentDetail = data;
        const isOwner = data.submitted_by_id === currentMemberId;
        modalTitle.textContent = data.item_title;
        modalDesc.textContent = data.item_desc || "제출한 내용을 확인할 수 있습니다.";
        setDetailStatus(data.status, data.rejected_reason || "");
        detailContent.textContent = data.content;
        renderAttachments(detailAttachments, data.attachments || []);
        detailParticipants.innerHTML = '';
        (data.participants || []).forEach(name => {
            const chip = document.createElement('span');
            chip.className = 'participant-chip';
            chip.textContent = name;
            detailParticipants.appendChild(chip);
        });
        if (!detailParticipants.children.length) {
            detailParticipants.innerHTML = '<div class="helper">함께한 팀원이 없습니다.</div>';
        }
        detailEditBtn.style.display = isOwner ? 'inline-flex' : 'none';
        detailCancelBtn.style.display = isOwner ? 'inline-flex' : 'none';
        showSection(detailSection);
        backdrop.style.display = 'flex';
    }

    function getSubmission(itemId) {
        return submissionData[itemId] || submissionData[String(itemId)] || null;
    }

    tiles.forEach(tile => {
        tile.addEventListener('click', () => {
            const status = tile.dataset.status;
            const itemId = tile.dataset.itemId;
            if (status === 'pending' || status === 'rejected' || status === 'approved') {
                const data = getSubmission(itemId);
                if (data) {
                    openDetail(itemId, data);
                } else {
                    alert("제출 정보를 불러오지 못했습니다. 새로고침 후 다시 시도해주세요.");
                }
                return;
            }
            if (status === 'approved') { return; }
            openForm(itemId, tile.dataset.title, tile.dataset.desc, 'create');
        });
    });

    cancelBtn.addEventListener('click', closeModal);
    closeBtn.addEventListener('click', closeModal);
    backdrop.addEventListener('click', (e) => { if (e.target === backdrop) closeModal(); });

    detailEditBtn.addEventListener('click', () => {
        if (!currentDetail) return;
        openForm(activeItemId, currentDetail.item_title, currentDetail.item_desc, 'edit', currentDetail);
    });

    detailCancelBtn.addEventListener('click', () => {
        if (!activeSubmissionId) return;
        if (!confirm("등록을 취소할까요? 첨부 파일과 내용이 모두 삭제됩니다.")) return;
        cancelForm.action = `{% url 'cancel_submission' 0 %}`.replace('/0/', `/${activeSubmissionId}/`);
        cancelForm.submit();
    });

    fileSelectBtn.addEventListener('click', () => attachmentInput.click());

    attachmentInput.addEventListener('change', () => {
        const files = Array.from(attachmentInput.files || []);
        addFiles(files);
        // DataTransfer가 없는 브라우저에서는 실제 input.files를 그대로 유지해야 업로드가 전송된다.
        if (!supportsDataTransfer) {
            fileQueue = Array.from(attachmentInput.files || []);
            renderSelectedPreviews(fileQueue);
        }
    });

    ['dragenter', 'dragover'].forEach(ev => {
        dropZone.addEventListener(ev, (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add('dragover');
        });
    });
    ['dragleave', 'drop'].forEach(ev => {
        dropZone.addEventListener(ev, (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('dragover');
        });
    });
    dropZone.addEventListener('drop', (e) => {
        const files = Array.from(e.dataTransfer.files || []);
        if (!files.length) return;
        addFiles(files);
        if (!supportsDataTransfer) {
            // DataTransfer 할당이 불가한 환경에서는 드롭한 파일을 그대로 input에 반영
            attachmentInput.files = e.dataTransfer.files;
            fileQueue = Array.from(attachmentInput.files || []);
            renderSelectedPreviews(fileQueue);
        }
    });

    historyBtn.addEventListener('click', () => {
        renderHistory();
        historyBackdrop.style.display = 'flex';
    });
    historyClose.addEventListener('click', () => { historyBackdrop.style.display = 'none'; });
    historyBackdrop.addEventListener('click', (e) => { if (e.target === historyBackdrop) historyBackdrop.style.display = 'none'; });

    form.addEventListener('submit', (e) => {
        // 제출 직전 파일을 재동기화해 전송 누락을 방지
        if (fileQueue.length) {
            syncInputFiles();
        } else if (!supportsDataTransfer) {
            fileQueue = Array.from(attachmentInput.files || []);
        }

        const checked = form.querySelectorAll('input[name="participants"]:checked').length;
        if (checked < 3) {
            e.preventDefault();
            alert("팀원 최소 3명을 선택해주세요. (본인 포함 4명 이상)");
            return;
        }
        const files = fileQueue;
        const mode = form.dataset.mode || 'create';
        const existingCount = parseInt(form.dataset.existingCount || '0', 10);
        const effectiveCount = files.length > 0 ? files.length : existingCount;
        if (effectiveCount === 0) {
            e.preventDefault();
            alert("사진 또는 동영상 최소 1개를 첨부해주세요.");
            return;
        }
        if (effectiveCount > 5) {
            e.preventDefault();
            alert("첨부 파일은 최대 5개까지만 가능합니다.");
            return;
        }
        if (!confirm(confirmMessage)) {
            e.preventDefault();
        }
    });

    if (bingoLineCompleted) {
        launchConfetti();
        showBingoToast();
    }
</script>
{% endblock %}
